{"version":3,"file":"reactivity.cjs.js","sources":["../../shared/src/index.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["export const isObject = (value)=> typeof value === 'object' && value != null\r\n\r\nexport const extend = Object.assign\r\n\r\nexport const isArray = Array.isArray\r\n\r\nexport const isFunction = (value)=> typeof value === 'function'\r\n\r\nexport const isNumber = (value)=> typeof value === 'number'\r\n\r\nexport const isString = (value)=> typeof value === 'string'\r\n\r\nexport const isIntegerKey = (key)=> parseInt(key)+'' === key\r\n\r\nlet hasOwnProperty = Object.prototype.hasOwnProperty\r\nexport const hasOwn = (target, key) => hasOwnProperty.call(target, key)\r\n\r\nexport const hasChanged = (oldValue, value) => value !== oldValue","import { isArray, isIntegerKey } from \"@vue/shared\";\r\nimport { TriggerOrTypes } from \"./operators\";\r\n\r\nexport function effect(fn, options: any = {}) {\r\n  const effect = createReactiveEffect(fn, options);\r\n  if (!options.lazy) {\r\n    //effect 默认会执行一次\r\n    effect();\r\n  }\r\n  return effect;\r\n}\r\nlet uid = 0;\r\nlet activeEffect;\r\nconst effectStack = [];\r\nfunction createReactiveEffect(fn, options: any = {}) {\r\n  const effect = function reactiveEffect() {\r\n    if (!effectStack.includes(effect)) {\r\n      try {\r\n        activeEffect = effect;\r\n        effectStack.push(effect);\r\n        fn();\r\n      } finally {\r\n        effectStack.pop();\r\n        activeEffect = effectStack[effectStack.length - 1];\r\n      }\r\n    }\r\n  };\r\n  effect.id = uid++;\r\n  effect._isEffect = true;\r\n  effect.raw = fn;\r\n  effect.options = options;\r\n  return effect;\r\n}\r\n\r\nconst targetMap = new WeakMap();\r\nexport function track(target, type, key) {\r\n  if (activeEffect === undefined) return;\r\n  let depsMap = targetMap.get(target);\r\n  if (!depsMap) {\r\n    targetMap.set(target, (depsMap = new Map()));\r\n  }\r\n  let dep = depsMap.get(key);\r\n  if (!dep) {\r\n    depsMap.set(key, (dep = new Set()));\r\n  }\r\n  if (!dep.has(activeEffect)) {\r\n    dep.add(activeEffect);\r\n  }\r\n}\r\n//找属性对应的effect 让其执行（数组、对象）\r\nexport function trigger(target, type, key?, newValue?, oldValue?) {\r\n  const depsMap = targetMap.get(target);\r\n  if (!depsMap) return;\r\n  const effects = new Set();\r\n  const add = (effectsToAdd) => {\r\n    if (effectsToAdd) {\r\n      effectsToAdd.forEach((effect) => effects.add(effect));\r\n    }\r\n  };\r\n  if (key === \"length\" && isArray(target)) {\r\n    depsMap.forEach((dep, key) => {\r\n      if (key === \"length\" || key > newValue) {\r\n        add(dep);\r\n      }\r\n    });\r\n  } else {\r\n    //可能是对象\r\n    if(key !=undefined){\r\n      add(depsMap.get(key))\r\n    }\r\n    switch(type){\r\n      case TriggerOrTypes.ADD:\r\n        if(isArray(target) && isIntegerKey(key)){\r\n          add(depsMap.get('length'))\r\n        }\r\n    }\r\n  }\r\n  effects.forEach((effect: any) => {\r\n    effect();\r\n  });\r\n}\r\n","import { isObject, extend, isArray, isIntegerKey, hasOwn, hasChanged } from \"@vue/shared\"\r\nimport { reactive, readonly } from \"./reactive\";\r\nimport { track, trigger } from \"./effect\";\r\nimport { TrackOpTypes, TriggerOrTypes } from \"./operators\";\r\nconst readonlyObj = {\r\n    set:(target, key)=> {\r\n        console.log(`set on key ${key} falied`);\r\n    }\r\n}\r\nfunction createGetter(isReadonly = false, shallow = false){\r\n    return (target,key,receiver)=> {\r\n        const res = Reflect.get(target, key, receiver)\r\n        if(shallow){\r\n            //如果是浅的 直接返回当前值\r\n            return res\r\n        }\r\n        if(!isReadonly){\r\n            //如果不是仅读的则需要收集当前以来，以便修改值时通知依赖更新\r\n            console.log('执行effect时会取值','收集effect');\r\n            track(target, TrackOpTypes.GET, key)\r\n            \r\n        }\r\n        if(isObject(res)){\r\n            //如果当前值还是对象 则需要继续递归代理\r\n            return isReadonly?readonly(res):reactive(res)\r\n        }\r\n        return res\r\n    }\r\n}\r\nfunction createSetter(shallow = false){\r\n    return (target, key, value, receiver)=> {\r\n        const oldValue = target[key]\r\n        let hasKey = isArray(target) && isIntegerKey(key) ? Number(key) < target.length : hasOwn(target, key)\r\n        const result = Reflect.set(target, key, value,  receiver)\r\n        if(!hasKey){\r\n            //新增\r\n            trigger(target, TriggerOrTypes.ADD, key, value)\r\n        }else if(hasChanged(oldValue, value)){\r\n            //修改\r\n            trigger(target, TriggerOrTypes.SET, key, value, oldValue)\r\n        }\r\n       \r\n        //当数据更新时 通知对应属性收集的effect重新执行\r\n        return result\r\n    }\r\n}\r\n\r\nconst set = createSetter()\r\nconst shallowSet = createSetter(true)\r\nconst get = createGetter()\r\nconst shallowGet = createGetter(false, true)\r\nconst readonlyGet = createGetter(true)\r\nconst shallowReadonlyGet = createGetter(true, true)\r\n\r\n\r\nconst reactiveHandler = {\r\n    get,\r\n    set\r\n}\r\nconst shallowReactiveHandler = {\r\n    get:shallowGet,\r\n    set:shallowSet,\r\n}\r\nconst readonlyHandler = extend({\r\n    get:readonlyGet\r\n},readonlyObj)\r\n\r\nconst shallowReadonlyHandler = extend({\r\n    get:shallowReadonlyGet\r\n},readonlyObj)\r\n\r\nexport {\r\n    reactiveHandler,\r\n    shallowReactiveHandler,\r\n    readonlyHandler,\r\n    shallowReadonlyHandler\r\n}","import { isObject } from \"@vue/shared\"\r\nimport { reactiveHandler, readonlyHandler, shallowReactiveHandler, shallowReadonlyHandler } from \"./baseHandlers\"\r\nexport function reactive(target){\r\n    return createReactiveObject(target, false, reactiveHandler)\r\n}\r\nexport function shallowReactive(target){\r\n    return createReactiveObject(target, false, shallowReactiveHandler)\r\n}\r\nexport function readonly(target){\r\n    return createReactiveObject(target, true, readonlyHandler)\r\n}\r\nexport function shallowReadonly(target){\r\n    return createReactiveObject(target, true, shallowReadonlyHandler)\r\n}\r\nconst reactiveMap = new WeakMap()\r\nconst readonlyMap = new WeakMap()\r\nexport function createReactiveObject(target, isReadonly, baseHandlers){\r\n    if(!isObject(target)) return target\r\n    const proxyMap = isReadonly?readonlyMap:reactiveMap\r\n    const existProxy = proxyMap.get(target)\r\n    if(existProxy)return existProxy\r\n    const proxy = new Proxy(target, baseHandlers)\r\n    proxyMap.set(target, proxy)\r\n    return proxy\r\n}"],"names":[],"mappings":"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"}